From: Huang Rui <vowstar@gmail.com>
Date: Tue, 10 Dec 2025 00:00:00 +0000
Subject: [PATCH] Fix assembler syntax detection for GCC wrapper

When using GCC as the assembler compiler, the --help output doesn't
include assembler-specific options like -msyntax=intel. We need to
check the actual assembler (as) instead. Also strip -Wa, prefix from
flags when checking for support since these are GCC pass-through flags.

--- a/make/cpp2asm_support.cmake
+++ b/make/cpp2asm_support.cmake
@@ -279,16 +279,29 @@
 endif (APPLE)
 if (UNIX AND NOT APPLE)
   # We require gas >= 2.18.50 for --32, --64, and the new -msyntax=intel, etc.
+  # Always check 'as' directly since GCC's --help doesn't show assembler options
   execute_process(COMMAND
-    ${CMAKE_ASM_COMPILER} --help
+    as --help
     RESULT_VARIABLE asm_result
     ERROR_VARIABLE asm_error
     OUTPUT_VARIABLE asm_out)
   if (asm_result OR asm_error)
+    # Fallback to CMAKE_ASM_COMPILER if 'as' is not found
+    execute_process(COMMAND
+      ${CMAKE_ASM_COMPILER} --help
+      RESULT_VARIABLE asm_result
+      ERROR_VARIABLE asm_error
+      OUTPUT_VARIABLE asm_out)
+  endif ()
+  if (asm_result OR asm_error)
     message(FATAL_ERROR "*** ${CMAKE_ASM_COMPILER} failed: ***\n${asm_error}")
   endif (asm_result OR asm_error)
   # turn the flags into a vector
   string(REGEX REPLACE " " ";" flags_needed "${ASM_FLAGS}")
+  # Strip -Wa, prefix from flags (used when GCC is the assembler compiler)
+  string(REGEX REPLACE "-Wa," "" flags_needed "${flags_needed}")
+  # Split comma-separated flags that were passed to -Wa,
+  string(REGEX REPLACE "," ";" flags_needed "${flags_needed}")
   # -mfpu= and -march do not list the possibilities
   string(REGEX REPLACE "-mfpu=[a-z]*" "-mfpu" flags_needed "${flags_needed}")
   string(REGEX REPLACE "-march=[+-a-z]*" "-march" flags_needed "${flags_needed}")
